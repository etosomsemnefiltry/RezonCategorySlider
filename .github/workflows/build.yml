name: Build Plugin

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup PHP
      uses: shivammathur/setup-php@v2
      with:
        php-version: '8.2'
        extensions: mbstring, xml, ctype, iconv, intl, pdo, pdo_mysql, dom, filter, gd, iconv, json, mbstring
        coverage: none
        
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        
    - name: Install Composer
      run: |
        curl -sS https://getcomposer.org/installer | php
        sudo mv composer.phar /usr/local/bin/composer
        
    - name: Allow Composer plugins
      run: |
        composer config --no-plugins allow-plugins.symfony/runtime true || true
        composer config --no-plugins allow-plugins.composer/package-versions-deprecated true || true
        
    - name: Get plugin version
      id: plugin-version
      run: |
        VERSION=$(grep -oP '"version":\s*"\K[^"]+' composer.json)
        echo "version=$VERSION" >> $GITHUB_OUTPUT
        echo "Plugin version: $VERSION"
        
    - name: Install Shopware for compilation
      run: |
        # Создаем временную директорию для Shopware
        mkdir -p shopware-temp
        cd shopware-temp
        
        # Устанавливаем Shopware 6.7.0 через composer
        echo "Установка Shopware 6.7.0..."
        composer create-project shopware/production . --no-interaction --prefer-dist --no-dev --ignore-platform-reqs
        
        # Создаем правильную структуру плагина
        mkdir -p custom/plugins/RezonCategorySlider
        
        # Копируем все файлы плагина
        cp -r ../src custom/plugins/RezonCategorySlider/src
        cp ../composer.json custom/plugins/RezonCategorySlider/
        cp ../LICENSE custom/plugins/RezonCategorySlider/ 2>/dev/null || true
        
    - name: Compile administration
      run: |
        cd shopware-temp
        
        # Устанавливаем зависимости плагина
        echo "Установка зависимостей плагина..."
        cd custom/plugins/RezonCategorySlider
        composer install --no-dev --optimize-autoloader --no-interaction --ignore-platform-reqs
        cd ../../..
        
        # Регистрируем плагин
        echo "Регистрация плагина..."
        php bin/console plugin:refresh --no-interaction || true
        
        # Компилируем административную часть
        echo "Компиляция административной части..."
        php bin/console bundle:dump || true
        
    - name: Create plugin archive
      id: create-archive
      run: |
        PLUGIN_NAME="RezonCategorySlider"
        VERSION="${{ steps.plugin-version.outputs.version }}"
        ARCHIVE_NAME="${PLUGIN_NAME}-v${VERSION}-${GITHUB_SHA:0:7}.zip"
        
        # Создаем временную директорию для архива
        mkdir -p build
        
        # Копируем скомпилированный плагин из Shopware
        if [ -d "shopware-temp/custom/plugins/RezonCategorySlider" ]; then
          echo "Копирование скомпилированного плагина..."
          cp -r shopware-temp/custom/plugins/RezonCategorySlider/src build/src
          cp shopware-temp/custom/plugins/RezonCategorySlider/composer.json build/
          if [ -f "shopware-temp/custom/plugins/RezonCategorySlider/LICENSE" ]; then
            cp shopware-temp/custom/plugins/RezonCategorySlider/LICENSE build/
          fi
        else
          echo "Копирование исходников плагина (fallback)..."
          cp -r src build/src
          cp composer.json build/
          cp LICENSE build/ 2>/dev/null || true
        fi
        
        # Создаем архив
        cd build
        zip -r "../${ARCHIVE_NAME}" .
        cd ..
        
        echo "archive_name=${ARCHIVE_NAME}" >> $GITHUB_OUTPUT
        echo "Created archive: ${ARCHIVE_NAME}"
        
    - name: Upload artifact
      uses: actions/upload-artifact@v4
      with:
        name: plugin-archive
        path: ${{ steps.create-archive.outputs.archive_name }}
        retention-days: 30
        
    - name: Create release info
      run: |
        echo "## Plugin Build Information" >> build-info.md
        echo "" >> build-info.md
        echo "- **Version:** ${{ steps.plugin-version.outputs.version }}" >> build-info.md
        echo "- **Commit:** ${{ github.sha }}" >> build-info.md
        echo "- **Branch:** ${{ github.ref_name }}" >> build-info.md
        echo "- **Build Date:** $(date -u +'%Y-%m-%d %H:%M:%S UTC')" >> build-info.md
        echo "" >> build-info.md
        echo "### Download" >> build-info.md
        echo "Архив плагина доступен в разделе Artifacts этого workflow." >> build-info.md
        
    - name: Upload build info
      uses: actions/upload-artifact@v4
      with:
        name: build-info
        path: build-info.md
        retention-days: 30

